ê¸°ë³¸ JWT ë°©ì‹ì˜ ì¸ì¦(ë³´ì•ˆ)ì„ ê°•í™”ì‹œí‚¨ ì•¡ì„¸ìŠ¤ & ë¦¬í”„ë ˆì‹œ í† í° ì¸ì¦ ë°©ì‹ì— ëŒ€í•´ ì•Œì•„ë³´ì. 

## ë¦¬í”„ë ˆì‹œ í† í°ì´ í•„ìš”í•œ ì´ìœ 

ì•¡ì„¸ìŠ¤ í† í°ë§Œì„ ì´ìš©í•œ ì¸ì¦ ë°©ì‹ì˜ ë¬¸ì œì ì€ **ì œ 3ìê°€ í† í°ì„ íƒˆì·¨í•˜ë©´ ëŒ€ì²˜ê°€ ì–´ë µë‹¤**ëŠ” ê²ƒì´ë‹¤. 

ì•¡ì„¸ìŠ¤ í† í°ì€ ë°œê¸‰ëœ ì´í›„ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šê³  í† í° ìì²´ë¡œ ê²€ì¦ì„ í•˜ë©° ì‚¬ìš©ì ê¶Œí•œì„ ì¸ì¦í•œë‹¤. ë”°ë¼ì„œ, **ì•¡ì„¸ìŠ¤ í† í°ì´ íƒˆì·¨ë˜ë©´ í† í°ì´ ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ í† í°ì„ íšë“í•œ ëˆ„êµ¬ë‚˜ ì‚¬ìš©ì ê¶Œí•œì„ ì–»ê²Œ ëœë‹¤.** 

JWTì€ ë°œê¸‰ ì´í›„ ì„ì˜ ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì—, **ì•¡ì„¸ìŠ¤ í† í°ì— 'ìœ íš¨ ì‹œê°„'ì„ ë¶€ì—¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íƒˆì·¨ ë¬¸ì œì— ëŒ€ì‘**í•  ìˆ˜ ìˆë‹¤. 

ì•¡ì„¸ìŠ¤ í† í°ì˜ ìœ íš¨ê¸°ê°„ì„ ì§§ê²Œ í•˜ë©´ í† í°ì„ ë‚¨ìš©í•˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆì§€ë§Œ, ìœ íš¨ê¸°ê°„ì´ ì§§ì€ ë§Œí¼ ì‚¬ìš©ìëŠ” ë” ìì£¼ ë¡œê·¸ì¸ì„ í•˜ì—¬ ìƒˆë¡­ê²Œ í† í°ì„ ë°œê¸‰ ë°›ì•„ì•¼ í•˜ë¯€ë¡œ ë¶ˆí¸í•˜ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. ê·¸ë ‡ë‹¤ê³  ìœ íš¨ê¸°ê°„ì„ ë¬´í„±ëŒ€ë¡œ ëŠ˜ë¦¬ë©´ í† í°ì„ íƒˆì·¨ ë‹¹í–ˆì„ ë•Œ ë³´ì•ˆì— ì·¨ì•½í•´ì§„ë‹¤. 

ì´ë•Œ í•„ìš”í•œ ê²ƒì´ ë°”ë¡œ **ë¦¬í”„ë ˆì‹œ í† í°**ì´ë‹¤! 

ë¦¬í”„ë ˆì‹œ í† í°ë„ ì•¡ì„¸ìŠ¤ í† í°ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ JWTì´ë‹¤. ë‹¨ì§€ ì•¡ì„¸ìŠ¤ í† í°ì€ ìœ ì € ì •ë³´ **ì ‘ê·¼**ì— ê´€ì—¬í•˜ëŠ” í† í°ì´ê³ , ë¦¬í”„ë ˆì‹œ í† í°ì€ ì•¡ì„¸ìŠ¤ í† í°ì˜ **ì¬ë°œê¸‰**ì— ê´€ì—¬í•˜ëŠ” í† í°ì´ë¼ëŠ” ì ì—ì„œ ì—­í• ì˜ ì°¨ì´ê°€ ìˆì„ ë¿ì´ë‹¤. 

## ì•¡ì„¸ìŠ¤ / ë¦¬í”„ë ˆì‹œ í† í° ì¸ì¦ ë°©ì‹

1. ì‚¬ìš©ìê°€ ì„œë²„ì— ë¡œê·¸ì¸ ìš”ì²­ì„ ë³´ë‚¸ë‹¤. 
2. ì„œë²„ëŠ” ë¡œê·¸ì¸ì„ ì„±ê³µì‹œí‚¤ë©´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ **ì•¡ì„¸ìŠ¤ í† í°, ë¦¬í”„ë ˆì‹œ í† í°ì„ ë™ì‹œì— ë°œê¸‰**í•œë‹¤. 
3. **ì„œë²„ëŠ” ë¦¬í”„ë ˆìŠ¤ í† í°ì„ DBì— ì €ì¥**í•˜ê³ , **í´ë¼ì´ì–¸íŠ¸ëŠ” ì•¡ì„¸ìŠ¤ í† í°, ë¦¬í”„ë ˆì‹œ í† í°**ì„ ì¿ í‚¤, ì„¸ì…˜, ì›¹ìŠ¤í† ë¦¬ì§€, **ë¡œì»¬ ì €ì¥ì†Œ ë“±ì— ì €ì¥**í•˜ê³  ìš”ì²­ì´ ìˆì„ ë•Œë§ˆë‹¤ ë‘ ê°€ì§€ í† í°ì„ í—¤ë”ì— ë‹´ì•„ì„œ ë³´ë‚¸ë‹¤. 
4. í´ë¼ì´ì–¸íŠ¸ê°€ ë§Œë£Œëœ ì•¡ì„¸ìŠ¤ í† í°ì„ ì„œë²„ì— ë³´ë‚´ë©´, ì„œë²„ëŠ” ê°™ì´ ë³´ë‚´ì§„ **ë¦¬í”„ë ˆì‹œ í† í°ì„ DBì— ì €ì¥ëœ ê²ƒê³¼ ë¹„êµí•˜ì—¬ ì¼ì¹˜í•˜ë©´ ì•¡ì„¸ìŠ¤ í† í°ì„ ì¬ë°œê¸‰**í•œë‹¤. 
5. ì‚¬ìš©ìê°€ **ë¡œê·¸ì•„ì›ƒ í•˜ë©´ ì•¡ì„¸ìŠ¤ í† í°, ë¦¬í”„ë ˆì‹œ í† í°ì„ ëª¨ë‘ ë§Œë£Œ**ì‹œí‚¨ë‹¤. 
6. ìƒˆë¡œ ë¡œê·¸ì¸ í•˜ë©´ ì„œë²„ë¡œë¶€í„° ë‹¤ì‹œ ì•¡ì„¸ìŠ¤ & ë¦¬í”„ë ˆì‹œ í† í°ì„ ë°œê¸‰ ë°›ê³ , ì„œë²„ëŠ” ë¦¬í”„ë ˆì‹œ í† í°ì„ DBì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— í† í° ì¸ì¦ ì‹œ ì‚¬ìš©í•œë‹¤. 

## í† í° ë§Œë£Œì— ë”°ë¥¸ ì²˜ë¦¬ 

| ì•¡ì„¸ìŠ¤ í† í° | ë¦¬í”„ë ˆì‹œ í† í°  |  |
| --- | --- | --- |
| ë§Œë£Œ X | ë§Œë£Œ X | ì •ìƒ ì²˜ë¦¬  |
| ë§Œë£Œ O | ë§Œë£Œ X | DBì— ì €ì¥ëœ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì¸ì¦ ê³¼ì •ì„ ê±°ì³ ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰  |
| ë§Œë£Œ X | ë§Œë£Œ O | ì•¡ì„¸ìŠ¤ í† í°ì´ ìœ íš¨í•˜ë‹¤ëŠ” ê±´ ì´ë¯¸ ì¸ì¦ëœ ê²ƒì´ë¯€ë¡œ ë°”ë¡œ ë¦¬í”„ë ˆì‹œ í† í° ì¬ë°œê¸‰  |
| ë§Œë£Œ O | ë§Œë£Œ O | ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì‹œí‚¤ê³  ë‹¤ì‹œ ë¡œê·¸ì¸ í•˜ì—¬, ì•¡ì„¸ìŠ¤, ë¦¬í”„ë ˆì‹œ í† í° ëª¨ë‘ ì¬ë°œê¸‰  |

## OkHttp Token Interceptor

[](https://www.notion.so/3647902f79bb40d9b307178ecbadc0a9?pvs=21) 

```kotlin
package org.go.sopt.winey.data.interceptor

import // ...

class AuthInterceptor @Inject constructor(
    @ApplicationContext context: Context,
    private val json: Json,
    private val dataStoreRepository: DataStoreRepository
) : Interceptor {

    override fun intercept(chain: Interceptor.Chain): Response {        
        val originalRequest = chain.request()
        val headerRequest = originalRequest.newAuthBuilder().build()
        val response = chain.proceed(headerRequest)

        when (response.code) {
            CODE_TOKEN_EXPIRED -> { 
                try {
                    Timber.e("ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ, í† í° ì¬ë°œê¸‰ í•©ë‹ˆë‹¤.")
                    response.close()
                    return handleTokenExpired(chain, originalRequest, headerRequest)
                } catch (t: Throwable) {
                    Timber.e("ì˜ˆì™¸ ë°œìƒ ${t.message}")
                    saveAccessToken("", "")
                }
            }

            CODE_INVALID_USER -> {
                saveAccessToken("", "")
            }
        }
        
        return response
    }

    private fun handleTokenExpired(
        chain: Interceptor.Chain,
        originalRequest: Request,
        headerRequest: Request
    ): Response {
		    // ì„œë²„ê°€ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì¸ì¦í•˜ì—¬ ì•¡ì„¸ìŠ¤ í† í°ì„ ì¬ë°œê¸‰ í•´ì¤€ë‹¤. 
        val refreshTokenRequest = originalRequest.newBuilder().post("".toRequestBody())
            .url("$AUTH_BASE_URL/auth/token")
            .addHeader(REFRESH_TOKEN, runBlocking(Dispatchers.IO) { getRefreshToken() })
            .build()
            
        val refreshTokenResponse = chain.proceed(refreshTokenRequest)
        if (refreshTokenResponse.isSuccessful) {
            val responseToken = json.decodeFromString(
                refreshTokenResponse.body?.string().toString()
            ) as BaseResponse<ResponseReIssueTokenDto>
            
            // ìƒˆë¡œ ë°œê¸‰ëœ ì•¡ì„¸ìŠ¤, ë¦¬í”„ë ˆì‹œ í† í°ì„ ë°ì´í„°ìŠ¤í† ì–´ì— ì €ì¥ 
            if (responseToken.data != null) {
                saveAccessToken(
                    responseToken.data.accessToken,
                    responseToken.data.refreshToken
                )
            }
            refreshTokenResponse.close()
            
            // ìƒˆë¡œ ë°œê¸‰ ë°›ì€ ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­ í—¤ë”ì— ì¶”ê°€ 
            val newRequest = originalRequest.newAuthBuilder().build()
            return chain.proceed(newRequest)
        } else {
            refreshTokenResponse.close()
            saveAccessToken("", "")
            return chain.proceed(headerRequest)
        }
    }
    
    private fun Request.newAuthBuilder() =
        this.newBuilder().addHeader(HEADER_TOKEN, runBlocking(Dispatchers.IO) { getAccessToken() })

    private suspend fun getAccessToken(): String {
        return dataStoreRepository.getAccessToken().first() ?: ""
    }

    private suspend fun getRefreshToken(): String {
        return dataStoreRepository.getRefreshToken().first() ?: ""
    }

    private fun saveAccessToken(accessToken: String, refreshToken: String) =
        runBlocking {
            dataStoreRepository.saveAccessToken(accessToken, refreshToken)
        }

    companion object {
        private const val CODE_TOKEN_EXPIRED = 401
        private const val CODE_INVALID_USER = 404
        private const val HEADER_TOKEN = "accessToken"
        private const val REFRESH_TOKEN = "refreshToken"
    }
}
```

## ë¦¬í”„ë ˆì‹œ í† í°ì´ ë§Œë£Œëœ ê²½ìš°

### ë°©ë²• 1. ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ ì¼ì£¼ì¼ ì „, ì•¡ì„¸ìŠ¤ í† í°ê³¼ í•¨ê»˜ ì¬ë°œê¸‰ ì§„í–‰

https://devtalk.kakao.com/t/refresh-token/19265

ì„œë²„ë¡œë¶€í„° ì•¡ì„¸ìŠ¤ í† í°ì„ ì¬ë°œê¸‰ ë°›ì„ ë•Œ ë¦¬í”„ë ˆì‹œ í† í°ì´ ë™ì¼í•˜ë‹¤ë©´, ë¦¬í”„ë ˆì‹œ í† í°ì˜ ë§Œë£Œ ê¸°ê°„ì€ 7ì¼ë³´ë‹¤ ë” ë§ì´ ë‚¨ì€ ê²ƒì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. 

ë°˜ë©´ì—, ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ ì‹œê°„ì´ 7ì¼ ì´í•˜ë¡œ ë‚¨ì•˜ì„ ë•Œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì„œë²„ëŠ” ë¦¬í”„ë ˆì‹œ í† í°ë„ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ë‚´ë ¤ì¤˜ì•¼ í•œë‹¤. 

### ë°©ë²• 2. ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ â†’ 401 ì—ëŸ¬ â†’ ë¡œê·¸ì•„ì›ƒ & ë¡œê·¸ì¸ â†’ ì•¡ì„¸ìŠ¤, ë¦¬í”„ë ˆì‹œ í† í° ì¬ë°œê¸‰

<img width="600" src="https://github.com/leeeha/Android-TIL/assets/68090939/3e369cb7-03c0-4a0f-a210-e624f92f2c13"/>

í˜„ì¬ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì¸ ìœ„ë‹ˆ ì„œë²„ì—ì„œëŠ” **ì•¡ì„¸ìŠ¤ í† í°ì„ ì¬ë°œê¸‰ ë°›ì„ ë•Œ ë¦¬í”„ë ˆì‹œ í† í°ë„ ê°±ì‹ ì‹œí‚¨ë‹¤**ê³  í•œë‹¤. 

ê·¸ë˜ì„œ ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰ ë°›ì„ ë•Œ ì‘ë‹µìœ¼ë¡œ ì˜¤ëŠ” ì•¡ì„¸ìŠ¤, ë¦¬í”„ë ˆì‹œ í† í° ëª¨ë‘ ë°ì´í„°ìŠ¤í† ì–´ì— ìƒˆë¡œ ì €ì¥í•´ì¤˜ì•¼ í•œë‹¤. 

## ì°¸ê³ ìë£Œ

[ğŸŒ Access Token & Refresh Token ì›ë¦¬](https://inpa.tistory.com/entry/WEB-ğŸ“š-Access-Token-Refresh-Token-ì›ë¦¬-feat-JWT)

[Refresh JWT Tokens in Android with OkHttp Interceptor](https://proandroiddev.com/refresh-jwt-tokens-in-android-with-okhttp-interceptor-575aaa4b6)