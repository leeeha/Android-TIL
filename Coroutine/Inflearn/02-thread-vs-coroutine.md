# 프로세스 vs 스레드

- **프로세스** : 컴퓨터에서 실행되고 있는 프로그램
- **스레드**
    - 프로세스보다 작은 개념
    - 프로세스에 소속되어 **여러 코드를 동시에 실행**할 수 있도록 해준다.
- 한 프로세스가 여러 개의 스레드를 갖고 있다면 **멀티 스레드 환경**이라고 한다.
- **스레드는 프로세스가 있어야만 존재**할 수 있고, 스레드는 코드를 실행하며 **스레드가 프로세스보다 작은 개념**이라고 할 수 있다.

<img width="500" src="https://github.com/leeeha/Android-TIL/assets/68090939/9fb563b9-11d9-4036-8e2d-c9d93eb1b081"/>

# 스레드 vs 코루틴

그렇다면, 코루틴은 무엇일까? **코루틴은 스레드보다 작은 개념**이다. 하지만, 프로세스와 스레드의 관계를 스레드와 코루틴의 관계에 빗대기에는 스레드와 코루틴에 차이가 꽤나 존재한다. 

우선, 스레드는 프로세스가 있어야만 존재할 수 있다. 그리고 **스레드는 자신이 실행되고 있는 프로세스를 바꿀 수는 없다.** 코루틴은 단지 우리가 작성한 루틴, 코드의 한 종류이기 때문에 코루틴 코드를 실행하려면, 마찬가지로 스레드가 있어야만 한다. 하지만 **코루틴은 중단되었다가 재개될 때 다른 스레드에 배정될 수 있다!** 

아래 그림처럼 중단 전의 코루틴 코드 1은 스레드 1번에서 실행되고

<img width="600" src="https://github.com/leeeha/Android-TIL/assets/68090939/76cba9ff-138e-489b-b8f2-5f540ed682ba"/>

<img width="600" src="https://github.com/leeeha/Android-TIL/assets/68090939/ab7d88a6-8da7-4ee9-b9bb-2e4914a4e942"/>

중단 후의 코루틴 코드 2는 스레드 2번에서 실행될 수 있다. 

<img width="600" src="https://github.com/leeeha/Android-TIL/assets/68090939/c24b2008-c80d-4c41-8677-e29495b07c5a"/>

프로세스, 스레드, 코루틴은 Context Switching 과정에서도 차이가 있다. 

## 프로세스 Context Switching

- 프로세스는 각각 **독립된 메모리 영역**을 갖고 있기 때문에 1번 프로세스에서 2번 프로세스로 실행 환경이 변경되면 **힙 영역, 스택 영역 모두 교체**되어야 한다.
- 따라서 프로세스 간의 **컨텍스트 스위칭 비용이 제일 크다.**

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/205e0290-508f-45fe-90c0-feda85b7cffa"/>

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/91fbb3bc-faec-4380-98bc-940e7e1172c7"/>

## 스레드 Context Switching

- 스레드는 **독립적인 스택 영역**을 갖고 있지만, **힙 영역을 공유**하기 때문에 실행 환경이 변경되면 **스택 영역만 교체**하면 된다.
- 따라서 **프로세스보다는 컨텍스트 스위칭 비용이 적게 든다.**

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/752c82db-f269-400c-b47a-bab5d9b89845"/>

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/85b59dbc-1eaa-4d7b-96b6-ac15fa8cbd7b"/>

## 코루틴 Context Switching

- 코루틴은 1번 코루틴과 2번 코루틴이 동일한 스레드에서 실행될 수 있다.
- 따라서 **동일한 스레드에서 코루틴이 실행되면, 메모리 전부를 공유**하므로 **스레드보다도 컨텍스트 스위칭 비용이 적게 든다.**

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/c34b3cbb-ee74-45f3-9b20-f9da4ac2a6a3"/>

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/213f3e7c-fd4e-415a-8219-2410e5b182dc"/>

<img width="700" src="https://github.com/leeeha/Android-TIL/assets/68090939/885fa3ff-e92d-49c7-994d-1327719717be"/>

또한, 스레드는 동시성을 확보하기 위해 여러 개의 스레드가 필요하다. 반면에, 코루틴은 1번 코루틴과 2번 코루틴이 하나의 스레드에서 번갈아 실행될 수 있기 때문에 **단 하나의 스레드만으로도 동시성을 확보**할 수 있다.

cf) 동시성 vs 병렬성 

- 동시성 (Concurrency) : 한 번에 한 가지 일만 할 수 있는데, 두 작업이 아주 빠르게 전환되어 마치 동시에 수행하는 것 '처럼' 보이는 것
- 병렬성 (Parallelism) : CPU 코어가 여러 개 있어서 '실제로' 2가지 일을 동시에 수행하는 것

마지막으로 코루틴은 yield 함수를 사용했던 것처럼 **스스로가 다른 코루틴에게 자리를 양보할 수 있다.** 

반면, 스레드는 보통 **OS가 현재 실행되고 있는 스레드를 멈추고 다른 스레드가 실행되도록 한다.** 

코루틴과 같은 방식을 ‘**비선점형**’이라 부르고, 스레드와 같은 방식을 ‘**선점형**’이라 부른다. 

# 요약

| 스레드 | 코루틴 |
| --- | --- |
| 프로세스보다 작은 개념이다.  | 스레드보다 작은 개념이다. |
| 한 스레드는 오직 한 프로세스에만 포함되어 있다.  | 한 코루틴의 코드는 여러 스레드에서 실행될 수 있다.  |
| 컨텍스트 스위칭 발생 시, 스택 영역이 교체된다.  | 한 스레드에서 실행되는 경우, 컨텍스트 스위칭 시 메모리 교체가 없다.  |
| OS가 스레드를 강제로 멈추고 다른 스레드를 실행한다. (선점형) | 코루틴 스스로가 다른 코루틴에게 양보한다. (비선점형) |

## 코루틴이 경량 스레드인 이유

- 스레드보다 **빠르고 적은 비용으로 코루틴 생성** 가능
- 하나의 스레드에서 여러 코루틴이 번갈아 가며 실행될 때 메모리를 전부 공유하므로, **메모리 사용량이 줄어들고 컨텍스트 스위칭 비용도 발생하지 않는다.**
    - 반면에, 스레드는 스택 영역 교체 필요. 그래서 코루틴은 **Stackless**라고 불림.
    - 참고로 하나의 스레드에 여러 개의 코루틴이 존재할 수 있지만, 실행은 하나만 할 수 있음.
- 스레드는 동시성을 구현하기 위해 여러 개의 스레드가 필요하지만, 코루틴은 **하나의 스레드만으로도 동시성을 구현**할 수 있다.

# 참고 자료 

https://charlezz.com/?p=44634
